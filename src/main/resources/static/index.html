<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机械配件商城</title>
    <style>
        /* 全局样式 */
        body {
            margin: 0;
            font-family: "微软雅黑", Arial, sans-serif;
            background: #f5f5f5;
        }

        /* 头部样式 */
        .header {
            background: #fff;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .header .container {
            width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #0074d9;
        }

        .search-bar {
            flex: 1;
            margin: 0 40px;
            display: flex;
        }

        .search-bar input {
            width: 300px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 3px 0 0 3px;
        }

        .search-bar button {
            padding: 6px 20px;
            border: none;
            background: #0074d9;
            color: #fff;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
        }

        .user-info {
            font-size: 14px;
        }

        .phone {
            font-size: 16px;
            color: #333;
            margin-left: 20px;
        }

        /* 导航栏样式 */
        .nav {
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
        }

        .nav .container {
            display: flex;
        }

        .nav-menu {
            display: flex;
        }

        .nav-menu a {
            padding: 14px 24px;
            color: #333;
            text-decoration: none;
            font-size: 16px;
        }

        .nav-menu a.active,
        .nav-menu a:hover {
            color: #0074d9;
            border-bottom: 2px solid #0074d9;
        }

        /* 主体内容样式 */
        .main {
            display: flex;
            width: 1200px;
            margin: 20px auto;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 220px;
            background: #fff;
            border: 1px solid #eee;
        }

        .sidebar ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .sidebar li {
            position: relative;
        }

        .sidebar > ul > li > a {
            display: block;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .sidebar > ul > li > a:hover,
        .sidebar > ul > li.active > a {
            background: #0074d9;
            color: #fff;
        }

        .submenu {
            display: none;
            position: absolute;
            left: 220px;
            top: 0;
            background: #fff;
            border: 1px solid #eee;
            min-width: 300px;
            z-index: 10;
        }

        .sidebar li:hover .submenu {
            display: block;
        }

        .submenu ul {
            padding: 10px;
        }

        .submenu li {
            padding: 4px 0;
        }

        /* Banner样式 */
        .banner {
            flex: 1;
            margin-left: 20px;
        }

        .banner img {
            width: 100%;
            border-radius: 6px;
        }

        /* 产品展示区域样式 */
        .content-area {
            flex: 1;
            margin-left: 20px;
        }

        .products-container {
            background: #fff;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            transition: box-shadow 0.3s;
        }

        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
        }

        .product-name {
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
            color: #333;
        }

        .product-price {
            font-size: 18px;
            color: #e74c3c;
            font-weight: bold;
        }

        .product-stock {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .product-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-view,
        .btn-add-cart {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-view {
            background: #0074d9;
            color: #fff;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-add-cart {
            background: #28a745;
            color: #fff;
        }

        .btn-add-cart:hover {
            background: #1e7e34;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        .category-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        /* 登录按钮样式 */
        .login-btn {
            padding: 6px 12px;
            border: none;
            background: #0074d9;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .login-btn:hover {
            background: #0056b3;
        }

        /* 用户信息下拉菜单样式 */
        .user-dropdown {
            position: relative;
            display: inline-block;
            margin-left: 20px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #0074d9;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            font-size: 14px;
        }

        .user-name {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 120px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            z-index: 100;
        }

        .dropdown-menu a {
            display: block;
            padding: 8px 15px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }

        .dropdown-menu a:hover {
            background: #f5f5f5;
        }

        .dropdown-menu.show {
            display: block;
        }

        .logout-btn {
            color: #e74c3c !important;
            border-top: 1px solid #eee;
        }

        /* 分类菜单样式 */
        .category-menu {
            display: flex;
            position: relative;
            width: 220px;
        }

        .main-category-list {
            width: 220px;
            background: #fff;
            border-right: 1px solid #eee;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .main-category-list li {
            padding: 12px 20px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }

        .main-category-list li.active,
        .main-category-list li:hover {
            background: #f5f7fa;
            color: #e1251b;
        }

        .sub-category-panel {
            position: absolute;
            left: 220px;
            top: 0;
            background: #fff;
            min-width: 600px;
            min-height: 100%;
            border: 1px solid #eee;
            z-index: 10;
            padding: 20px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .sub-category-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .sub-category-list {
            display: flex;
            flex-wrap: wrap;
        }

        .sub-category-group {
            width: 200px;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .sub-category-group a {
            display: inline-block;
            margin: 2px 8px 2px 0;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }

        .sub-category-group a:hover {
            color: #e1251b;
            text-decoration: underline;
        }

        /* 加载指示器 */
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast消息样式 */
        .toast-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        .toast-message.success {
            background-color: #4CAF50;
        }

        .toast-message.error {
            background-color: #f44336;
        }

        .toast-message.fade-out {
            animation: fadeOut 0.5s ease-out;
            opacity: 0;
        }

        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <div class="logo">机械配件商城</div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="搜索配件">
            <button id="searchBtn">搜索</button>
        </div>
        <div class="user-info">
            <a href="cart.html" class="cart-icon" style="margin-right: 20px;">
                <span>购物车</span>
                <span id="cartCount" style="background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">0</span>
            </a>
            <!-- 登录/用户信息区域 -->
            <div id="authArea">
                <!-- 默认显示登录/注册 -->
                <span id="loginText">访问<a href="login.html" style="color:#0074d9;margin:0 5px;">登录</a>|<a href="register.html" style="color:#0074d9;margin:0 5px;">注册</a></span>

                <!-- 登录后显示的内容 -->
                <div class="user-dropdown" id="userDropdown" style="display:none;">
                    <div class="user-name">
                        <span class="user-avatar" id="userAvatar">U</span>
                        <span id="usernameDisplay">用户名</span>
                    </div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="myaccount.html">我的账户</a>
                        <a href="myorders.html">我的订单</a>
                        <a href="myfavorites.html">我的关注</a>
                        <a href="#" class="logout-btn" id="logoutBtn">退出登录</a>
                    </div>
                </div>
            </div>
            <span class="phone">4000-XXX-XXX</span>
        </div>
    </div>
</div>

<div class="nav">
    <div class="container">
        <div class="nav-menu">
            <a href="#" class="active">配件商城</a>
            <a href="#">金融服务</a>
            <a href="#">销售/服务网络</a>
            <a href="#">积分商城</a>
        </div>
    </div>
</div>

<div class="main">
    <div class="category-menu">
        <ul class="main-category-list" id="mainCategoryList">
            <!-- 主分类通过JS动态生成 -->
        </ul>
        <div class="sub-category-panel" id="subCategoryPanel" style="display:none;"></div>
    </div>
    <div class="content-area">
        <div class="banner">
            <img src="https://img.zcool.cn/community/01b2e95b2e2e6fa801216518a2e2e7.jpg" alt="banner">
        </div>
        <div class="products-container">
            <div class="category-title" id="categoryTitle">请选择产品分类</div>
            <div id="productsContainer">
                <div class="loading">请从左侧选择产品分类</div>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>
    $(function() {
        // 检查用户是否登录
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userId = parseInt(localStorage.getItem('userId'));
            const username = localStorage.getItem('username');

            if (token && !isNaN(userId) && userId > 0 && username) {
                // 用户已登录，显示用户信息
                $('#loginText').hide();
                $('#userDropdown').show();
                $('#usernameDisplay').text(username);

                // 设置用户头像首字母
                const firstLetter = username.charAt(0).toUpperCase();
                $('#userAvatar').text(firstLetter);

                // 更新购物车数量
                updateCartCount();
            } else {
                // 用户未登录，显示登录/注册
                $('#loginText').show();
                $('#userDropdown').hide();
                $('#cartCount').text('0');
                localStorage.removeItem('userId');
                localStorage.removeItem('token');
                localStorage.removeItem('username');
            }
        }

        // 显示Toast消息
        function showToast(message, type = 'success') {
            const toast = $(`<div class="toast-message ${type}">${message}</div>`);
            $('body').append(toast);

            setTimeout(() => {
                toast.addClass('fade-out');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // 更新购物车数量
        function updateCartCount() {
            try {
                const userId = parseInt(localStorage.getItem('userId'));

                if (isNaN(userId) || userId <= 0) {
                    $('#cartCount').text('0');
                    return;
                }

                $.ajax({
                    url: 'http://localhost:8080/api/cart/count',
                    method: 'GET',
                    data: { userId: userId },
                    dataType: 'json',
                    success: function(response) {
                        if (response && response.status === 0) {
                            $('#cartCount').text(response.data.count || 0);
                        } else {
                            console.error('获取购物车数量失败:', response.msg);
                            $('#cartCount').text('0');
                        }
                    },
                    error: function(xhr) {
                        console.error('获取购物车数量请求失败:', xhr.responseText);
                        $('#cartCount').text('0');
                    }
                });
            } catch (error) {
                console.error('更新购物车数量出错:', error);
                $('#cartCount').text('0');
            }
        }

        // 添加到购物车
        function addToCart(productId, event) {
            event.preventDefault();
            event.stopPropagation();

            try {
                const userId = parseInt(localStorage.getItem('userId'));
                productId = parseInt(productId);
                const $button = $(event.target).hasClass('btn-add-cart')
                    ? $(event.target)
                    : $(event.target).closest('.btn-add-cart');

                if (isNaN(userId) || userId <= 0) {
                    showToast('请先登录', 'error');
                    window.location.href = 'login.html';
                    return;
                }

                if (isNaN(productId) || productId <= 0) {
                    throw new Error('无效的商品ID');
                }

                const originalText = $button.html();
                $button.prop('disabled', true).html('<span class="loading-spinner"></span>添加中...');

                $.ajax({
                    url: 'http://localhost:8080/api/cart/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        userId: userId,
                        productId: productId,
                        quantity: 1
                    }),
                    success: function(response) {
                        if (response && response.status === 0) {
                            showToast('商品已添加到购物车');
                            updateCartCount();
                            $button.html('已添加');
                            setTimeout(() => {
                                $button.prop('disabled', false).html(originalText);
                            }, 2000);
                        } else {
                            throw new Error(response.msg || '添加购物车失败');
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON && xhr.responseJSON.msg
                            ? xhr.responseJSON.msg
                            : '服务器错误，请稍后再试';
                        throw new Error(errorMsg);
                    }
                });
            } catch (error) {
                console.error('添加购物车出错:', error.message);
                showToast(error.message, 'error');
                if ($button) {
                    $button.prop('disabled', false).html(originalText || '加入购物车');
                }
            }
        }

        // 查看商品详情
        function viewDetail(productId) {
            window.location.href = `product.html?id=${productId}`;
        }

        // 用户信息下拉菜单
        $('.user-name').on('click', function() {
            $('#dropdownMenu').toggleClass('show');
        });

        // 点击其他地方关闭下拉菜单
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.user-dropdown').length) {
                $('#dropdownMenu').removeClass('show');
            }
        });

        // 退出登录
        $('#logoutBtn').on('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            showToast('已退出登录');
            setTimeout(() => window.location.href = 'index.html', 1000);
        });

        // 搜索功能
        $('#searchBtn').on('click', function() {
            const keyword = $('#searchInput').val().trim();
            if (keyword) {
                window.location.href = `search.html?keyword=${encodeURIComponent(keyword)}`;
            } else {
                showToast('请输入搜索关键词', 'error');
            }
        });

        $('#searchInput').on('keypress', function(e) {
            if (e.which === 13) {
                $('#searchBtn').click();
            }
        });

        // 平铺数组转树结构
        function listToTree(list) {
            const map = {};
            const roots = [];
            list.forEach(item => {
                map[item.id] = { ...item, children: [] };
            });
            list.forEach(item => {
                if (item.parentId !== 0 && map[item.parentId]) {
                    map[item.parentId].children.push(map[item.id]);
                } else if (item.parentId === 0) {
                    roots.push(map[item.id]);
                }
            });
            return roots;
        }

        // 渲染主分类
        function renderMainCategories(tree) {
            const $mainList = $('#mainCategoryList');
            $mainList.empty();

            tree.forEach(cat => {
                const $li = $(`<li data-id="${cat.id}">${cat.name}</li>`);

                $li.on('mouseenter', () => showSubCategory(cat, $li));
                $li.on('mouseleave', () => hideSubCategory());
                $li.on('click', function(e) {
                    e.stopPropagation();
                    loadProductsByCategoryId(cat.id, cat.name);
                });

                $mainList.append($li);
            });
        }

        // 显示子分类面板
        function showSubCategory(cat, $li) {
            const $panel = $('#subCategoryPanel');
            $panel.empty().show();
            $li.addClass('active');

            if (cat.children && cat.children.length > 0) {
                cat.children.forEach(sub => {
                    const $group = $(`
                        <div class="sub-category-group">
                            <div class="sub-category-title">${sub.name}</div>
                        </div>
                    `);

                    if (sub.children && sub.children.length > 0) {
                        sub.children.forEach(item => {
                            $group.append(
                                $('<a href="#">').text(item.name).on('click', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    loadProductsByCategoryId(item.id, item.name);
                                })
                            );
                        });
                    }

                    $group.find('.sub-category-title').on('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        loadProductsByCategoryId(sub.id, sub.name);
                    });

                    $panel.append($group);
                });
            }

            $panel.on('mouseenter', () => {
                $panel.show();
                $li.addClass('active');
            }).on('mouseleave', () => {
                $panel.hide();
                $li.removeClass('active');
            });
        }

        function hideSubCategory() {
            $('#subCategoryPanel').hide();
            $('#mainCategoryList li').removeClass('active');
        }

        // 加载并渲染产品
        function loadProductsByCategoryId(categoryId, categoryName) {
            $('#categoryTitle').text(categoryName);
            const $container = $('#productsContainer');
            $container.html('<div class="loading">正在加载产品...</div>');

            $.ajax({
                url: `http://localhost:8080/api/products?categoryId=${categoryId}`,
                method: 'GET',
                dataType: 'json',
                success: function(products) {
                    if (!products || products.length === 0) {
                        $container.html('<div class="loading">该分类暂无产品</div>');
                        return;
                    }

                    let html = '<div class="products-grid">';
                    products.forEach(product => {
                        const imageUrl = product.iconUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="200" viewBox="0 0 250 200"><rect width="100%" height="100%" fill="%23ddd"/><text x="50%" y="50%" font-family="Arial" font-size="16" text-anchor="middle" fill="%23333">产品图片</text></svg>';
                        const price = product.price ? `¥${product.price.toFixed(2)}` : '¥0.00';
                        const stock = product.stock || 0;

                        html += `
                        <div class="product-card" data-product-id="${product.id}">
                            <img src="${imageUrl}" alt="${product.name}" class="product-image">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">${price}</div>
                            <div class="product-stock">库存: ${stock} 件</div>
                            <div class="product-actions">
                                <button class="btn-view" onclick="viewDetail(${product.id})">查看详情</button>
                                <button class="btn-add-cart" onclick="addToCart(${product.id}, event)">加入购物车</button>
                            </div>
                        </div>
                        `;
                    });
                    html += '</div>';
                    $container.html(html);
                },
                error: function(xhr) {
                    $container.html('<div class="error">加载产品失败，请稍后重试</div>');
                    console.error('加载产品失败:', xhr.responseText);
                }
            });
        }

        // 初始化检查登录状态
        checkLoginStatus();

        // 加载分类数据
        $.ajax({
            url: 'http://localhost:8080/api/categories',
            method: 'GET',
            dataType: 'json',
            success: function(list) {
                const tree = listToTree(list);
                renderMainCategories(tree);
            },
            error: function(xhr) {
                console.error('加载分类错误:', xhr.responseText);
                $('#mainCategoryList').html('<li>加载分类失败</li>');
            }
        });
    });
</script>
</body>
</html>