<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理 - 商品管理</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--primary-color);
            font-weight: 500;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--light-color);
            font-weight: 500;
            color: var(--dark-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            opacity:0.9;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn i {
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 8px;
            width: 50%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--primary-color);
            font-weight: 500;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: var(--dark-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-btn:hover {
            background-color: var(--secondary-color);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1100;
        }

        .toast-success {
            background-color: var(--success-color);
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        .toast.show {
            opacity: 1;
        }

        /* 分类树样式 */
        .category-tree-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            overflow: auto;
        }

        .category-toolbar {
            padding: 10px;
            background: #f5f7fa;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .category-tree {
            flex: 1;
            padding: 10px;
            overflow: auto;
        }

        .category-tree ul {
            list-style: none;
            padding-left: 20px;
        }

        .category-tree li {
            margin: 5px 0;
            position: relative;
        }

        .tree-node {
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .tree-node:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .toggle {
            margin-right: 5px;
            width: 20px;
            text-align: center;
            cursor: pointer;
        }

        .toggle.hidden {
            visibility: hidden;
        }

        .node-content {
            flex: 1;
        }

        .category-detail {
            margin-top: 20px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* 级联选择器样式 */
        .category-selector {
            display: flex;
            gap: 10px;
        }

        .category-selector select {
            flex: 1;
        }

        .category-path {
            color: var(--primary-color);
            font-weight: 500;
            margin-left: 5px;
        }

        #productType {
            position: absolute;
            left: -9999px;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 90%;
                margin: 10% auto;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .category-selector {
                flex-direction: column;
            }

            .category-selector {
                position: relative;
            }

            .category-selector button {
                margin-top: 5px;
            }

            .category-path {
                font-weight: bold;
                color: var(--primary-color);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-boxes"></i> 商品管理</h1>
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="搜索商品...">
            <button class="search-btn" onclick="searchProducts()"> <i class="fas fa-search"></i> 搜索</button>
            <button class="search-btn" id="addProductBtn"> <i class="fas fa-plus-circle"></i> 新增商品</button>
        </div>
    </div>

    <div class="card">
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>编号</th>
                    <th>商品名称</th>
                    <th>价格</th>
                    <th>状态</th>
                    <th>是否热销</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="productTable">
                </tbody>
            </table>
        </div>
    </div>
</div>


<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-box-open"></i> 修改商品信息</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="editForm">
            <input type="hidden" id="editId">
            <div class="form-group">
                <label for="editName"><i class="fas fa-boxes"></i> 商品名称</label>
                <input type="text" id="editName" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editPrice"><i class="fas fa-tag"></i> 价格</label>
                <input type="number" id="editPrice" class="form-control" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="editStatus"><i class="fas fa-circle"></i> 状态</label>
                <select id="editStatus" class="form-control" required>
                    <option value="2">在售</option>
                    <option value="1">下架</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editIsHot"><i class="fas fa-fire"></i> 是否热销</label>
                <select id="editIsHot" class="form-control" required>
                    <option value="1">是</option>
                    <option value="0">否</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="submitEdit()">
                    <i class="fas fa-save"></i> 保存
                </button>
                <button type="button" class="btn" onclick="closeModal()"> <i class="fas fa-times"></i> 取消</button>
            </div>
        </form>
    </div>
</div>


<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> 新增商品</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="addForm">
            <div class="form-group">
                <label for="addName"><i class="fas fa-boxes"></i> 商品名称</label>
                <input type="text" id="addName" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="addPrice"><i class="fas fa-tag"></i> 商品价格</label>
                <input type="number" id="addPrice" class="form-control" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="addStock"><i class="fas fa-box"></i> 商品库存</label>
                <input type="number" id="addStock" class="form-control" min="0" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-cog"></i> 商品分类</label>
                <div class="category-selector">
                    <select class="form-control level-1" onchange="loadSubCategories(this, 2)">
                        <option value="">选择一级分类</option>

                    </select>
                    <select class="form-control level-2" style="display:none;" onchange="loadSubCategories(this, 3)">
                        <option value="">选择二级分类</option>
                    </select>
                    <select class="form-control level-3" style="display:none;">
                        <option value="">选择三级分类</option>
                    </select>

                </div>

                <input type="hidden" id="productType" name="productId">

                <div class="form-group">
                    <label>已选分类：<span id="categoryPath" class="category-path">未选择</span></label>
                </div>
                <button type="button" class="btn btn-sm btn-link" onclick="openCategoryManager()">
                    <i class="fas fa-cog"></i> 管理分类
                </button>
            </div>
            <div class="form-group">
                <label for="addDetail"><i class="fas fa-info-circle"></i> 商品详情</label>
                <textarea id="addDetail" class="form-control" rows="4" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="submitAdd()">
                    <i class="fas fa-save"></i> 保存
                </button>
                <button type="button" class="btn" onclick="closeModal()"> <i class="fas fa-times"></i> 取消</button>
            </div>
        </form>
    </div>
</div>


<div id="categoryModal" class="modal">
    <div class="modal-content" style="width: 70%;">
        <div class="modal-header">
            <h2><i class="fas fa-sitemap"></i> 商品分类管理</h2>
            <span class="close" onclick="closeCategoryModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="category-tree-container">
                <div class="category-toolbar">
                    <button class="btn btn-primary btn-sm" onclick="addCategory()">
                        <i class="fas fa-plus"></i> 新增分类
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="expandAll()">
                        <i class="fas fa-expand"></i> 展开全部
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="collapseAll()">
                        <i class="fas fa-compress"></i> 折叠全部
                    </button>
                </div>
                <div id="categoryTree" class="category-tree">

                </div>
            </div>

            <div id="categoryDetail" class="category-detail" style="display:none;">
                <h3 id="categoryDetailTitle">分类详情</h3>
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="form-group">
                        <label for="categoryName">分类名称</label>
                        <input type="text" id="categoryName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="parentCategory">父级分类ID</label>
                        <input type="number" id="parentCategory" class="form-control" min="0" value="0" required>
                        <small class="form-text text-muted">输入父级分类ID，0表示一级分类</small>
                    </div>
                    <div class="form-group">
                        <label for="categoryOrder">排序序号</label>
                        <input type="number" id="categoryOrder" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="categoryStatus">状态</label>
                        <select id="categoryStatus" class="form-control">
                            <option value="1">启用</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveCategory()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                        <button type="button" class="btn btn-danger" onclick="deleteCategory()">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                        <button type="button" class="btn" onclick="cancelEdit()">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentEditId = null;

    $(document).ready(function() {
        loadProducts();
        loadTopLevelCategories();

        $('#addProductBtn').click(function() {
            openAddModal();
        });
    });

    function loadProducts() {
        $.ajax({
            url: 'http://localhost:8080/api/products/all',
            type: 'GET',
            dataType: 'json',
            beforeSend: function() {
                $('#productTable').html('<tr><td colspan="6" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> 加载中...</td></tr>');
            },
            success: function(response) {
                if (response.status === 0 && response.data && response.data.length > 0) {
                    let html = '';
                    $.each(response.data, function(i, product) {
                        html += `<tr>
                                <td>${product.id}</td>
                                <td>${escapeHtml(product.name) || '-'}</td>
                                <td>${product.price ? product.price.toFixed(2) : '0.00'}</td>
                                <td>${product.status === 2 ? '<span class="status-badge status-active">在售</span>' :
                            '<span class="status-badge status-inactive">下架</span>'}</td>
                                <td>${product.isHot === 1 ? '<span class="status-badge status-active">是</span>' :
                            '<span class="status-badge status-inactive">否</span>'}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="openEditModal(${product.id}, '${escapeHtml(product.name)}', ${product.price}, ${product.status}, ${product.isHot})">
                                        <i class="fas fa-edit"></i> 修改
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>`;
                    });
                    $('#productTable').html(html);
                } else if (response.status === 0) {
                    $('#productTable').html('<tr><td colspan="6" style="text-align: center;">暂无商品数据</td></tr>');
                } else {
                    console.error('获取商品数据失败:', response.msg);
                    $('#productTable').html('<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">加载商品数据失败: ' + escapeHtml(response.msg) + '</td></tr>');
                }
            },
            error: function(xhr, status, error) {
                console.error('请求失败:', error);
                $('#productTable').html('<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">请求失败: ' + escapeHtml(error) + '</td></tr>');
            }
        });
    }

    function searchProducts() {
        const keyword = $('#searchInput').val().trim();
        if (keyword === '') {
            loadProducts();
            return;
        }

        $.ajax({
            url: 'http://localhost:8080/api/products/search',
            type: 'GET',
            dataType: 'json',
            data: { name: keyword },
            beforeSend: function() {
                $('#productTable').html('<tr><td colspan="6" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> 加载中...</td></tr>');
            },
            success: function(response) {
                if (response.status === 0 && response.data && response.data.length > 0) {
                    let html = '';
                    $.each(response.data, function(i, product) {
                        html += `<tr>
                                <td>${product.id}</td>
                                <td>${escapeHtml(product.name) || '-'}</td>
                                <td>${product.price ? product.price.toFixed(2) : '0.00'}</td>
                                <td>${product.status === 2 ? '<span class="status-badge status-active">在售</span>' :
                            '<span class="status-badge status-inactive">下架</span>'}</td>
                                <td>${product.isHot === 1 ? '<span class="status-badge status-active">是</span>' :
                            '<span class="status-badge status-inactive">否</span>'}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="openEditModal(${product.id}, '${escapeHtml(product.name)}', ${product.price}, ${product.status}, ${product.isHot})">
                                        <i class="fas fa-edit"></i> 修改
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>`;
                    });
                    $('#productTable').html(html);
                } else if (response.status === 0) {
                    $('#productTable').html('<tr><td colspan="6" style="text-align: center;">暂无匹配的商品数据</td></tr>');
                } else {
                    console.error('搜索商品失败:', response.msg);
                    $('#productTable').html('<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">搜索商品失败: ' + escapeHtml(response.msg) + '</td></tr>');
                }
            },
            error: function(xhr, status, error) {
                console.error('请求失败:', error);
                $('#productTable').html('<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">请求失败: ' + escapeHtml(error) + '</td></tr>');
            }
        });
    }

    // 打开编辑模态框
    function openEditModal(id, name, price, status, isHot) {
        currentEditId = id;
        $('#editId').val(id);
        $('#editName').val(name || '');
        $('#editPrice').val(price || '');
        $('#editStatus').val(status || '2');
        $('#editIsHot').val(isHot || '0');

        $('#editModal').addClass('show').show();
        $('body').css('overflow', 'hidden');
    }

    // 关闭模态框
    function closeModal() {
        $('#editModal').removeClass('show');
        $('#addModal').removeClass('show');
        setTimeout(() => {
            $('#editModal').hide();
            $('#addModal').hide();
            $('body').css('overflow', 'auto');
        }, 300);
    }

    // 提交编辑
    function submitEdit() {
        const product = {
            id: currentEditId,
            name: $('#editName').val().trim(),
            price: parseFloat($('#editPrice').val()),
            status: parseInt($('#editStatus').val()),
            isHot: parseInt($('#editIsHot').val())
        };

        if (!product.name) {
            showToast('error', '商品名称不能为空');
            return;
        }

        if (isNaN(product.price)){
            showToast('error', '请输入有效的价格');
            return;
        }

        if (isNaN(product.status)) {
            showToast('error', '请选择商品状态');
            return;
        }

        if (isNaN(product.isHot)) {
            showToast('error', '请选择是否热销');
            return;
        }

        $.ajax({
            url: 'http://localhost:8080/api/product',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(product),
            beforeSend: function() {
                $('.modal-content').append('<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> 保存中...</div>');
            },
            success: function(response) {
                if (response.status === 0) {
                    showToast('success', '修改成功');
                    closeModal();
                    loadProducts();
                } else {
                    showToast('error', '修改失败: ' + response.msg);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', '请求失败: ' + error);
            },
            complete: function() {
                $('.loading-overlay').remove();
            }
        });
    }

    // 删除商品
    function deleteProduct(id) {
        if (confirm('确定要删除此商品吗？此操作不可撤销！')) {
            $.ajax({
                url: 'http://localhost:8080/api/product/' + id,
                type: 'DELETE',
                beforeSend: function() {
                    $('.container').append('<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> 删除中...</div>');
                },
                success: function(response) {
                    if (response.status === 0) {
                        showToast('success', '删除成功');
                        loadProducts();
                    } else {
                        showToast('error', '删除失败: ' + response.msg);
                    }
                },
                error: function(xhr, status, error) {
                    showToast('error', '请求失败: ' + error);
                },
                complete: function() {
                    $('.loading-overlay').remove();
                }
            });
        }
    }

    // 打开新增模态框
    function openAddModal() {
        $('#addModal').addClass('show').show();
        $('body').css('overflow', 'hidden');
        // 重置分类选择器
        $('.level-2').hide().empty().append('<option value="">选择二级分类</option>');
        $('.level-3').hide().empty().append('<option value="">选择三级分类</option>');
        $('#productType').val('');
        $('#categoryPath').text('未选择');
    }

    // 提交新增商品
    function submitAdd() {
        const product = {
            name: $('#addName').val().trim(),
            price: parseFloat($('#addPrice').val()),
            stock: parseInt($('#addStock').val()),
            productId: $('#productType').val(),
            detail: $('#addDetail').val()
        };
        // 确保parts_id与product_id相同
        product.partsId = product.productId;

        if (!product.name) {
            showToast('error', '商品名称不能为空');
            return;
        }

        if (isNaN(product.price) || product.price <= 0) {
            showToast('error', '请输入有效的价格');
            return;
        }

        if (isNaN(product.stock) || product.stock < 0) {
            showToast('error', '库存数量必须为正整数');
            return;
        }

        if (!product.productId) {
            showToast('error', '请选择商品分类');
            return;
        }

        $.ajax({
            url: 'http://localhost:8080/api/product/add',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(product),
            beforeSend: function() {
                $('.modal-content').append('<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> 保存中...</div>');
            },
            success: function(response) {
                if (response.status === 0) {
                    showToast('success', '添加成功');
                    closeModal();
                    loadProducts();
                } else {
                    showToast('error', '添加失败: ' + response.msg);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', '请求失败: ' + error);
            },
            complete: function() {
                $('.loading-overlay').remove();
            }
        });
    }

    // 加载一级分类
    function loadTopLevelCategories() {
        $.ajax({
            url: 'http://localhost:8080/api/categories/level/0',
            type: 'GET',
            success: function(response) {
                if (response.status === 0) {
                    const $select = $('.level-1');
                    $select.empty().append('<option value="">选择一级分类</option>');
                    response.data.forEach(category => {
                        $select.append(`<option value="${category.id}">${category.name}</option>`);
                    });
                } else {
                    console.error('加载一级分类失败:', response.msg);
                }
            },
            error: function(xhr, status, error) {
                console.error('请求失败:', error);
            }
        });
    }

    // 加载子分类
    function loadSubCategories(selectElement, nextLevel) {
        const categoryId = $(selectElement).val();
        const $nextSelect = $(selectElement).closest('.category-selector').find('.level-' + nextLevel);

        // 重置下级选择器
        $nextSelect.hide().empty().append(`<option value="">选择${['一','二','三'][nextLevel-1]}级分类</option>`);

        // 清空更下级的选择器
        $(selectElement).closest('.category-selector')
            .find('.level-' + (nextLevel+1)).hide().empty().append('<option value="">选择三级分类</option>');

        // 重置最终产品类型值
        $('#productType').val('');
        updateCategoryPath();

        if (!categoryId) return;

        $.ajax({
            url: `http://localhost:8080/api/categories/children/${categoryId}`,
            type: 'GET',
            success: function(response) {
                if (response.status === 0) {
                    if (response.data && response.data.length > 0) {
                        // 有子分类，正常显示
                        response.data.forEach(category => {
                            $nextSelect.append(`<option value="${category.id}">${category.name}</option>`);
                        });
                        $nextSelect.show();
                    } else {
                        // 没有子分类的特殊处理
                        if (nextLevel === 2) {
                            // 二级分类没有子分类，直接使用二级分类ID
                            $('#productType').val(categoryId);
                            showToast('success', '已自动选择当前分类');
                            updateCategoryPath();
                        } else if (nextLevel === 3) {
                            // 三级分类本身就是最终分类
                            $('#productType').val(categoryId);
                            updateCategoryPath();
                        }
                    }
                }
            },
            error: function(xhr, status, error) {
                showToast('error', '加载子分类失败: ' + error);
            }
        });
    }

    // 更新分类路径显示
    function updateCategoryPath() {
        const level1 = $('.level-1 option:selected').text();
        const level2 = $('.level-2 option:selected').text();
        const level3 = $('.level-3 option:selected').text();

        let path = '';
        if (level1 && level1 !== '选择一级分类') path += level1;
        if (level2 && level2 !== '选择二级分类') path += ' > ' + level2;
        if (level3 && level3 !== '选择三级分类') path += ' > ' + level3;

        $('#categoryPath').text(path || '未选择');
    }

    // 打开分类管理模态框
    function openCategoryManager() {
        $('#categoryModal').addClass('show').show();
        $('body').css('overflow', 'hidden');
        loadCategoryTree();
        cancelEdit();
    }

    // 关闭分类管理模态框
    function closeCategoryModal() {
        $('#categoryModal').removeClass('show');
        setTimeout(() => {
            $('#categoryModal').hide();
            $('body').css('overflow', 'auto');
        }, 300);
    }

    // 加载分类树
    function loadCategoryTree() {
        $.ajax({
            url: 'http://localhost:8080/api/categories/tree',
            type: 'GET',
            beforeSend: function() {
                $('#categoryTree').html('<div style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>');
            },
            success: function(response) {
                if (response.status === 0) {
                    renderCategoryTree(response.data);
                } else {
                    showToast('error', '加载分类失败: ' + response.msg);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', '请求失败: ' + error);
            }
        });
    }

    // 渲染分类树
    function renderCategoryTree(categories) {
        const treeContainer = $('#categoryTree');
        treeContainer.empty();

        function buildTree(items, parentId = 0, level = 0) {
            const children = items.filter(item => item.parent_id === parentId);
            if (children.length === 0) return '';

            let html = '<ul>';
            children.forEach(item => {
                const hasChildren = items.some(child => child.parent_id === item.id);
                html += `
                    <li>
                        <div class="tree-node" data-id="${item.id}" data-level="${level}">
                            <span class="toggle ${hasChildren ? '' : 'hidden'}" onclick="toggleNode(this)">
                                <i class="fas fa-caret-right"></i>
                            </span>
                            <span class="node-content" onclick="showCategoryDetail(${item.id})">
                                ${item.name} (ID: ${item.id})
                            </span>
                        </div>
                        ${buildTree(items, item.id, level + 1)}
                    </li>
                `;
            });
            html += '</ul>';
            return html;
        }

        treeContainer.html(buildTree(categories));
    }

    // 显示分类详情
    function showCategoryDetail(categoryId) {
        $.ajax({
            url: 'http://localhost:8080/api/categories/' + categoryId,
            type: 'GET',
            success: function(response) {
                if (response.status === 0) {
                    const category = response.data;
                    $('#categoryDetailTitle').text('分类详情: ' + category.name);
                    $('#categoryId').val(category.id);
                    $('#categoryName').val(category.name);
                    $('#categoryOrder').val(category.sort_order || 0);
                    $('#categoryStatus').val(category.status);

                    // 加载父级分类选项
                    loadParentCategoryOptions(category.parent_id);

                    $('#categoryDetail').show();
                } else {
                    showToast('error', '加载分类详情失败: ' + response.msg);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', '请求失败: ' + error);
            }
        });
    }


    // 保存分类
    function saveCategory() {
        // 1. 获取原始输入值
        const rawParentId = $('#parentCategory').val();
        console.log("原始parentId输入值:", rawParentId, "类型:", typeof rawParentId);

        // 2. 转换为整数
        const parentId = parseInt(rawParentId);
        console.log("转换后的parentId:", parentId, "是否NaN:", isNaN(parentId));

        // 3. 准备提交数据
        const category = {
            id: $('#categoryId').val(),
            name: $('#categoryName').val().trim(),
            parent_id: isNaN(parentId) ? 0 : parentId, // 确保是有效数字
            sort_order: parseInt($('#categoryOrder').val()) || 0,
            status: parseInt($('#categoryStatus').val()) || 1
        };

        // 4. 验证最终数据
        console.log("完整的提交数据:", JSON.stringify(category, null, 2));
        console.log("parent_id字段类型:", typeof category.parent_id);

        // 5. 发送请求
        const url = category.id ? 'http://localhost:8080/api/categories/update' : 'http://localhost:8080/api/categories/add';
        const method = category.id ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(category),
            beforeSend: function() {
                $('#categoryDetail').append('<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> 保存中...</div>');
            },
            success: function(response) {
                console.log("保存响应:", response);
                if (response.status === 0) {
                    showToast('success', '保存成功');
                    loadCategoryTree();
                    cancelEdit();
                    loadTopLevelCategories();
                } else {
                    showToast('error', '保存失败: ' + response.msg);
                }
            },
            error: function(xhr, status, error) {
                console.error("保存错误:", status, error);
                showToast('error', '请求失败: ' + error);
            },
            complete: function() {
                $('.loading-overlay').remove();
            }
        });
    }

    // 删除分类
    function deleteCategory() {
        const categoryId = $('#categoryId').val();
        if (!categoryId || !confirm('确定要删除此分类吗？此操作不可撤销！')) return;

        $.ajax({
            url: 'http://localhost:8080/api/categories/' + categoryId,
            type: 'DELETE',
            beforeSend: function() {
                $('#categoryDetail').append('<div class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> 删除中...</div>');
            },
            success: function(response) {
                if (response.status === 0) {
                    showToast('success', '删除成功');
                    loadCategoryTree();
                    cancelEdit();
                    // 刷新分类选择器
                    loadTopLevelCategories();
                } else {
                    showToast('error', '删除失败: ' + response.msg);
                }
            },
            error: function(xhr, status, error) {
                showToast('error', '请求失败: ' + error);
            },
            complete: function() {
                $('.loading-overlay').remove();
            }
        });
    }

    function addCategory() {
        $('#categoryDetailTitle').text('新增分类');
        $('#categoryForm')[0].reset();
        $('#categoryId').val('');
        $('#parentCategory').val('0'); // 默认设置为一级分类
        $('#categoryDetail').show();
    }

    function cancelEdit() {
        $('#categoryDetail').hide();
    }

    function toggleNode(element) {
        const $toggle = $(element);
        const $li = $toggle.closest('li');
        const $children = $li.find('> ul');

        if ($children.is(':visible')) {
            $children.hide();
            $toggle.html('<i class="fas fa-caret-right"></i>');
        } else {
            $children.show();
            $toggle.html('<i class="fas fa-caret-down"></i>');
        }
    }

    function expandAll() {
        $('#categoryTree ul').show();
        $('#categoryTree .toggle').html('<i class="fas fa-caret-down"></i>');
    }

    function collapseAll() {
        $('#categoryTree ul').hide();
        $('#categoryTree .toggle').html('<i class="fas fa-caret-right"></i>');
    }

    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type === 'success' ? 'success' : 'error'}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }, 100);
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return unsafe;
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
</body>
</html>