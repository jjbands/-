<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å•†å“åˆ†ç±»ç®¡ç†</title>
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f5f7fa; margin: 0; }
        .container { display: flex; max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .tree-panel { width: 320px; border-right: 1px solid #eee; padding: 30px 20px 30px 30px; background: #fafbfc; }
        .tree-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .tree-header h2 { font-size: 20px; color: #4361ee; margin: 0; }
        .tree-header button { background: #4361ee; color: #fff; border: none; border-radius: 4px; padding: 6px 14px; cursor: pointer; font-size: 14px; }
        .category-tree ul { list-style: none; padding-left: 18px; }
        .category-tree li { margin: 4px 0; position: relative; }
        .tree-node { display: flex; align-items: center; cursor: pointer; padding: 3px 0; border-radius: 3px; }
        .tree-node.selected { background: #e9f0ff; color: #4361ee; }
        .tree-node .expand-btn { width: 18px; text-align: center; cursor: pointer; color: #888; font-size: 14px; }
        .tree-node .expand-btn.invisible { visibility: hidden; }
        .tree-node .node-name { flex: 1; padding-left: 2px; }
        .tree-node .add-btn { color: #4cc9f0; margin-left: 6px; font-size: 15px; cursor: pointer; }
        .tree-node .del-btn { color: #f72585; margin-left: 6px; font-size: 15px; cursor: pointer; }
        .detail-panel { flex: 1; padding: 40px 40px 40px 40px; }
        .detail-title { font-size: 20px; color: #4361ee; margin-bottom: 18px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 7px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px 10px; border: 1px solid #dbeafe; border-radius: 4px; font-size: 15px; }
        .form-actions { margin-top: 25px; }
        .form-actions button { padding: 8px 22px; border: none; border-radius: 4px; font-size: 15px; margin-right: 12px; cursor: pointer; }
        .form-actions .save-btn { background: #4361ee; color: #fff; }
        .form-actions .cancel-btn { background: #eee; color: #333; }
        .form-actions .del-btn { background: #f72585; color: #fff; }
        .empty-tip { color: #aaa; text-align: center; margin-top: 60px; }
    </style>
</head>
<body>
<div class="container">
    <div class="tree-panel">
        <div class="tree-header">
            <h2>å•†å“åˆ†ç±»</h2>
            <button onclick="addCategory(null)">æ–°å¢ä¸€çº§åˆ†ç±»</button>
        </div>
        <div class="category-tree" id="categoryTree"></div>
    </div>
    <div class="detail-panel">
        <div class="detail-title" id="detailTitle">è¯·é€‰æ‹©å·¦ä¾§åˆ†ç±»æˆ–æ–°å¢</div>
        <form id="categoryForm" style="display:none;">
            <input type="hidden" id="categoryId">
            <input type="hidden" id="categoryParentId">
            <div class="form-group">
                <label>åˆ†ç±»åç§°</label>
                <input type="text" id="categoryName" required>
            </div>
            <div class="form-group">
                <label>æ’åºåºå·</label>
                <input type="number" id="categoryOrder" min="0" value="0">
            </div>
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <select id="categoryStatus">
                    <option value="1">å¯ç”¨</option>
                    <option value="0">ç¦ç”¨</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="save-btn" onclick="saveCategory()">ä¿å­˜</button>
                <button type="button" class="cancel-btn" onclick="cancelEdit()">å–æ¶ˆ</button>
                <button type="button" class="del-btn" id="deleteBtn" style="display:none;" onclick="deleteCategory()">åˆ é™¤</button>
            </div>
        </form>
        <div class="empty-tip" id="emptyTip">æš‚æ— åˆ†ç±»ï¼Œè¯·ç‚¹å‡»å·¦ä¾§æ–°å¢</div>
    </div>
</div>
<script src="js/jquery.min.js"></script>
<script>
let categoryList = [];
let selectedNode = null;
let expandedIds = new Set();

function fetchCategoryTree() {
    $.get('/api/categories/tree', function(data) {
        categoryList = data;
        renderCategoryTree();
        if (selectedNode) {
            selectNode(selectedNode.id);
        }
    });
}
function renderCategoryTree() {
    const $tree = $('#categoryTree');
    $tree.empty();
    if (!categoryList || categoryList.length === 0) {
        $tree.html('<div class="empty-tip">æš‚æ— åˆ†ç±»</div>');
        return;
    }
    $tree.append(buildTreeHtml(categoryList, 0));
}
function buildTreeHtml(tree, level) {
    let html = '<ul style="margin-left:' + (level*18) + 'px">';
    tree.forEach(cat => {
        const hasChildren = cat.children && cat.children.length > 0;
        const expanded = expandedIds.has(cat.id);
        html += `<li>
            <div class="tree-node${selectedNode&&selectedNode.id===cat.id?' selected':''}">
                <span class="expand-btn${hasChildren?'':' invisible'}" onclick="toggleExpand(${cat.id}, event)">${hasChildren?(expanded?'â–¼':'â–¶'):''}</span>
                <span class="node-name" onclick="selectNode(${cat.id})">${cat.name}</span>
                <span class="add-btn" title="æ–°å¢å­åˆ†ç±»" onclick="addCategory(${cat.id}, event)">ï¼‹</span>
                <span class="del-btn" title="åˆ é™¤" onclick="deleteCategoryConfirm(${cat.id}, event)">ğŸ—‘</span>
            </div>`;
        if (hasChildren && expanded) {
            html += buildTreeHtml(cat.children, level+1);
        }
        html += '</li>';
    });
    html += '</ul>';
    return html;
}
function toggleExpand(id, e) {
    e.stopPropagation();
    if (expandedIds.has(id)) expandedIds.delete(id); else expandedIds.add(id);
    renderCategoryTree();
}
function selectNode(id) {
    selectedNode = categoryList.find(cat => cat.id === id);
    $('#categoryId').val(selectedNode.id);
    $('#categoryParentId').val(selectedNode.parentId);
    $('#categoryName').val(selectedNode.name);
    $('#categoryOrder').val(selectedNode.sortOrder||0);
    $('#categoryStatus').val(selectedNode.status);
    $('#categoryForm').show();
    $('#deleteBtn').show();
    $('#emptyTip').hide();
    $('#detailTitle').text('ç¼–è¾‘åˆ†ç±»');
    renderCategoryTree();
    autoExpandToNode(id);
}
function autoExpandToNode(id) {
    let node = categoryList.find(cat => cat.id === id);
    while (node && node.parentId && node.parentId !== 0) {
        expandedIds.add(node.parentId);
        node = categoryList.find(cat => cat.id === node.parentId);
    }
}
function addCategory(parentId, e) {
    if (e) e.stopPropagation();
    selectedNode = null;
    $('#categoryId').val('');
    $('#categoryParentId').val(parentId||0);
    $('#categoryName').val('');
    $('#categoryOrder').val(0);
    $('#categoryStatus').val(1);
    $('#categoryForm').show();
    $('#deleteBtn').hide();
    $('#emptyTip').hide();
    $('#detailTitle').text(parentId?'æ–°å¢å­åˆ†ç±»':'æ–°å¢ä¸€çº§åˆ†ç±»');
    if (parentId) expandedIds.add(parentId);
    renderCategoryTree();
}
function saveCategory() {
    const id = $('#categoryId').val();
    const parentId = parseInt($('#categoryParentId').val())||0;
    const name = $('#categoryName').val().trim();
    const sortOrder = parseInt($('#categoryOrder').val())||0;
    const status = parseInt($('#categoryStatus').val())||1;
    if (!name) { alert('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º'); return; }
    const data = { id, parentId, name, sortOrder, status };
    const url = id ? '/api/categories/update' : '/api/categories/add';
    const method = id ? 'PUT' : 'POST';
    $.ajax({ url, type: method, contentType:'application/json', data: JSON.stringify(data), success: function(res) {
        if (res.status === 0) {
            fetchCategoryTree();
            $('#categoryForm').hide();
            $('#emptyTip').show();
            $('#detailTitle').text('è¯·é€‰æ‹©å·¦ä¾§åˆ†ç±»æˆ–æ–°å¢');
        } else {
            alert(res.msg||'ä¿å­˜å¤±è´¥');
        }
    }});
}
function deleteCategoryConfirm(id, e) {
    e.stopPropagation();
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥åˆ†ç±»ï¼Ÿï¼ˆæœ‰å­åˆ†ç±»æ—¶è¯·å…ˆåˆ é™¤å­åˆ†ç±»ï¼‰')) return;
    deleteCategory(id);
}
function deleteCategory(id) {
    $.ajax({ url: '/api/categories/' + id, type: 'DELETE', success: function(res) {
        if (res.status === 0) {
            fetchCategoryTree();
            $('#categoryForm').hide();
            $('#emptyTip').show();
            $('#detailTitle').text('è¯·é€‰æ‹©å·¦ä¾§åˆ†ç±»æˆ–æ–°å¢');
        } else {
            alert(res.msg||'åˆ é™¤å¤±è´¥');
        }
    }});
}
function cancelEdit() {
    $('#categoryForm').hide();
    $('#emptyTip').show();
    $('#detailTitle').text('è¯·é€‰æ‹©å·¦ä¾§åˆ†ç±»æˆ–æ–°å¢');
    selectedNode = null;
    renderCategoryTree();
}
$(function(){ fetchCategoryTree(); });
</script>
</body>
</html> 